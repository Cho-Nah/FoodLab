package main

import (
	"encoding/json"
	"fmt"
	"log"
	"net/http"
	"os"
	"strings"

	"github.com/lib/pq"
	"gorm.io/driver/postgres"
	"gorm.io/gorm"
)

// Recipe – модель рецепта
type Recipe struct {
	ID           int            `gorm:"primaryKey" json:"id"`
	Title        string         `json:"title"`
	Ingredients  pq.StringArray `gorm:"type:text[]" json:"ingredients"`
	Instructions string         `json:"instructions"`
}

var db *gorm.DB

// initDB устанавливает соединение с БД и выполняет миграцию модели.
func initDB() {
	// Чтение параметров подключения из переменных окружения
	host := os.Getenv("DB_HOST")
	port := os.Getenv("DB_PORT")
	user := os.Getenv("DB_USER")
	password := os.Getenv("DB_PASSWORD")
	dbname := os.Getenv("DB_NAME")

	dsn := fmt.Sprintf("host=%s port=%s user=%s password=%s dbname=%s sslmode=disable", host, port, user, password, dbname)
	var err error
	db, err = gorm.Open(postgres.Open(dsn), &gorm.Config{})
	if err != nil {
		log.Fatal("Ошибка подключения к базе: ", err)
	}

	// Миграция схемы
	if err := db.AutoMigrate(&Recipe{}); err != nil {
		log.Fatal("Ошибка миграции: ", err)
	}
}

// SearchRequest – структура запроса для поиска рецептов.
type SearchRequest struct {
	Ingredients []string `json:"ingredients"`
}

// searchRecipes ищет рецепты, в списке ингредиентов которых есть хотя бы один совпадающий с запросом.
func searchRecipes(w http.ResponseWriter, r *http.Request) {
 withCORS(w)

 if r.Method == http.MethodOptions {
  w.WriteHeader(http.StatusOK)
  return
 }

 var req SearchRequest
 if err := json.NewDecoder(r.Body).Decode(&req); err != nil {
  http.Error(w, "Неверный формат запроса", http.StatusBadRequest)
  return
 }

 var queryIngredients []string
 for _, ing := range req.Ingredients {
  queryIngredients = append(queryIngredients, strings.ToLower(strings.TrimSpace(ing)))
 }

 var recipes []Recipe
 if err := db.Where("ingredients && ?", pq.Array(queryIngredients)).Find(&recipes).Error; err != nil {
  http.Error(w, "Ошибка запроса к базе", http.StatusInternalServerError)
  return
 }

 w.Header().Set("Content-Type", "application/json")
 json.NewEncoder(w).Encode(map[string]interface{}{
  "recipes": recipes,
 })
}


func main() {
	initDB()

	// Если таблица рецептов пуста – заполняем тестовыми данными
	var count int64
	db.Model(&Recipe{}).Count(&count)
	if count == 0 {
		seedData()
	}

	http.HandleFunc("/search", searchRecipes)
	log.Println("Сервер запущен на порту 8080")
	log.Fatal(http.ListenAndServe(":8080", nil))
}

// withCORS устанавливает CORS заголовок для ответа.
func withCORS(w http.ResponseWriter) {
 w.Header().Set("Access-Control-Allow-Origin", "*")
 w.Header().Set("Access-Control-Allow-Methods", "GET, POST, OPTIONS")
 w.Header().Set("Access-Control-Allow-Headers", "Content-Type")
}


// seedData заполняет базу тестовыми рецептами.
func seedData() {
	recipes := []Recipe{
		{
			ID: 1,
			Title: "Паста с томатным соусом",
			Ingredients: pq.StringArray{"паста", "томаты", "чеснок", "оливковое масло", "соль", "перец"},
			Instructions: "Отварите пасту в подсоленной воде согласно инструкции на упаковке до состояния аль денте. Пока паста варится, разогрейте оливковое масло на сковороде. Добавьте измельчённый чеснок и обжаривайте его до золотистого цвета, затем добавьте нарезанные томаты. Готовьте смесь на среднем огне, периодически помешивая, пока соус не загустеет (около 10 минут). В конце добавьте соль и перец по вкусу. Слейте воду с пасты и смешайте её с соусом. Подавайте горячим, посыпав пармезаном, если желаете.",
		},
		{
			ID: 2,
			Title: "Салат Цезарь",
			Ingredients: pq.StringArray{"салат", "курица", "пармезан", "крутоны", "соус Цезарь", "чеснок"},
			Instructions: "Начните с приготовления курицы: обжарьте куриные филе на сковороде до золотистой корочки с обеих сторон, приправьте солью и перцем. После этого нарежьте её на кусочки. Для приготовления салата нарвите свежий салат на крупные куски и выложите в большую миску. Положите сверху нарезанную курицу, добавьте натёртый пармезан и крутоны. Для заправки используйте готовый соус Цезарь или приготовьте его самостоятельно, смешав майонез, горчицу, чеснок и лимонный сок. Перемешайте все ингредиенты и подавайте сразу же.",
		},
		{
			ID: 3,
			Title: "Панкейки",
			Ingredients: pq.StringArray{"мука", "молоко", "яйца", "сахар", "соль", "разрыхлитель", "масло"},
			Instructions: "В глубокой миске смешайте сухие ингредиенты: муку, сахар, соль и разрыхлитель. В отдельной миске взбейте яйца с молоком. Постепенно добавляйте жидкую смесь к сухим ингредиентам, тщательно перемешивая венчиком, чтобы не было комков. Разогрейте сковороду с небольшим количеством масла. Выкладывайте тесто ложкой, образуя небольшие круги. Жарьте панкейки по 2-3 минуты с каждой стороны до золотистого цвета. Подавайте с сиропом, медом, свежими ягодами или фруктами по вкусу.",
		},
		{
			ID: 4,
			Title: "Омлет с овощами",
			Ingredients: pq.StringArray{"яйца", "помидоры", "перец", "лук", "оливковое масло", "соль", "перец"},
			Instructions: "Для приготовления омлета начните с подготовки овощей. Нарежьте помидоры, перец и лук мелкими кусочками. В небольшой миске взбейте яйца с солью и перцем. На сковороде разогрейте немного оливкового масла и обжарьте овощи до мягкости. Затем добавьте взбитые яйца, равномерно распределив их по сковороде. Готовьте омлет на среднем огне, пока он не схватится по краям. Переверните омлет на другую сторону или сложите пополам, чтобы он приготовился до конца. Подавайте горячим, посыпав зеленью.",
		},
		{
			ID: 5,
			Title: "Чили кон карне",
			Ingredients: pq.StringArray{"мясо", "фасоль", "помидоры", "лук", "чеснок", "перец чили", "соль", "перец"},
			Instructions: "Начните с обжарки мяса на сковороде до золотистой корочки. Добавьте мелко нарезанный лук и чеснок, жарьте ещё 2-3 минуты до прозрачности лука. Затем добавьте нарезанные помидоры и тушите всё вместе около 5 минут. Влейте воду или бульон, добавьте фасоль и мелко нарезанный перец чили. Тушите на медленном огне около 30 минут, пока смесь не станет густой. Посолите и поперчите по вкусу. Подавайте с рисом или тортильями.",
		},
		{
			ID: 6,
			Title: "Тосты с авокадо",
			Ingredients: pq.StringArray{"хлеб", "авокадо", "лимон", "соль", "перец"},
			Instructions: "Для приготовления тостов поджарьте хлеб до золотистой корочки в тостере или на сковороде. Пока тосты жарятся, разрежьте авокадо пополам, удалите косточку и выскоблите мякоть. Разомните мякоть вилкой, добавьте сок лимона, соль и перец по вкусу. Намажьте получившуюся массу на горячие тосты. Подавайте сразу, можно добавить немного острого соуса или семян чиа для украшения.",
		},
		{
			ID: 7,
			Title: "Ризотто с грибами",
			Ingredients: pq.StringArray{"рис", "грибы", "бульон", "лук", "чеснок", "сливки", "масло", "пармезан"},
			Instructions: "Обжарьте нарезанные грибы с луком и чесноком на сливочном масле до мягкости. Добавьте рис и продолжайте обжаривать его, пока он не станет полупрозрачным. Постепенно добавляйте горячий бульон, по половине чашки за раз, позволяя рису впитывать жидкость. Продолжайте добавлять бульон, пока рис не станет мягким и кремовым (около 20 минут). Когда рис будет готов, добавьте сливки и тертый пармезан. Подавайте горячим, посыпав ещё пармезаном и свежей зеленью.",
		},
		{
			ID: 8,
			Title: "Курица с картошкой",
			Ingredients: pq.StringArray{"курица", "картофель", "петрушка", "чеснок", "соль", "перец", "масло"},
			Instructions: "Нарежьте картофель крупными кусками и отложите в сторону. Куриные кусочки приправьте солью, перцем и измельченным чесноком. В разогретой сковороде с маслом обжарьте курицу до золотистой корочки с обеих сторон. После этого добавьте картофель и перемешайте. Переложите все в жаропрочную форму и запекайте в духовке при 180°C около 40-50 минут, пока курица и картофель не станут мягкими и золотистыми. Подавайте с нарезанной свежей петрушкой.",
		},
		{
			ID: 9,
			Title: "Торт с клубникой",
			Ingredients: pq.StringArray{"мука", "сахар", "яйца", "клубника", "сливки", "разрыхлитель"},
			Instructions: "Приготовьте бисквитное тесто: взбейте яйца с сахаром до пышной массы, затем добавьте просеянную муку и разрыхлитель. Вылейте тесто в форму и выпекайте в предварительно разогретой духовке при 180°C около 30-40 минут. Когда торт остынет, разрежьте его пополам и промажьте обе части сливками. Украсьте сверху свежими клубниками, нарезанными на ломтики, и полейте сахарной пудрой.",
		},
		{
			ID: 10,
			Title: "Суп-пюре из брокколи",
			Ingredients: pq.StringArray{"брокколи", "картофель", "морковь", "лук", "чеснок", "сливки", "соль", "перец"},
			Instructions: "Отварите картофель, морковь, брокколи и лук в подсоленной воде до мягкости. Когда овощи будут готовы, переложите их в блендер и измельчите до состояния пюре. Перелейте пюре в кастрюлю, добавьте немного воды или бульона, чтобы достичь желаемой консистенции. Добавьте сливки, соль и перец по вкусу, доведите до кипения и варите ещё 5 минут. Подавайте горячим, посыпав зеленью.",
		},
	}

	for _, r := range recipes {
		db.Create(&r)
	}
}

